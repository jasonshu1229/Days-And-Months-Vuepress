---
title: 实现Reconciler架构
date: 2023-03-17 12:37:45
permalink: /pages/10307f/
---

`Reconciler` 是 React 核心逻辑所在的模块，中文名叫`协调器`。

## Reconciler 架构介绍

在React中，`Reconciler`（协调器）是负责管理虚拟DOM树更新的关键部分。当组件状态或属性发生更改时，`Reconciler`的任务是确定如何有效地更新DOM来反映这些更改。这个过程通常被称为 **"协调"（Reconciliation）**。

`Reconciler`的核心思想是通过将新的虚拟DOM树与旧的虚拟DOM树进行比较，找出需要实际更新的部分，然后最小化实际DOM操作的数量。这个过程被称为"`diffing`"算法。

### reconciler 模块有什么优点？

在传统的库（jQuery）工作原理（过程驱动）

<center><img src="https://s2.loli.net/2023/03/17/zmRZqJlaUgNLhWi.png"/></center>

在传统的前端开发中使用的`jQuery`库的工作原理主要是通过一个简化和统一的API，使得开发者能够更容易地操作DOM、处理事件、创建动画以及发起AJAX请求等。而不是描述UI的状态。所以`jQuery`的工作原理是**过程驱动**的。

现代的前端框架结构与工作原理（状态驱动）

![现代的前端框架结构与工作原理](https://s2.loli.net/2023/03/17/dnZlQbyzAFwaY6k.png)

- 在现代的前端框架中，开发者使用描述UI的方法（template或JSX）来定义组件和它们之间的关系。
- 运行时核心模块根据描述的UI，管理组件的创建、更新和销毁，处理数据状态变更，并通过虚拟DOM或响应式系统来优化UI更新性能。
- 当需要与宿主环境交互时（如操作DOM、处理事件或发起网络请求），**运行时核心模块会调用宿主环境API**。前端框架通常会封装这些API，提供统一的跨平台接口。

### AOT 与 JIT

现代框架都需要“编译”这一步骤，用于：
- 将“框架中描述的UI”转换为宿主环境可识别的代码；
- 代码转化，比如将ts编译成js，实现polyfill等；
- 执行一些编译时优化

“编译”可以选择两个时机执行：

- **代码在构建时，被称为 AOT（Ahead Of Time，提前编译或预编译），宿主环境获得是编译后的代码**；
- **代码在宿主环境执行时，被称为 JIT（Just In Time，即时编译），代码在宿主环境中编译并执行**；

大部分采用模板语法描述UI的前端框架都会进行`AOT`优化，例如：Vue3、Angular、Svelte。

其本质原因在于**模板语法时固定的**，固定意味着“可分析”，“可分析”意味着在编译时可以标记模板语法中的静态部分（不变的部分）与动态部分（包含自变量、可变的部分）。

但采用JSX语法描述UI的前端框架很难从 `AOT`中受益，因为JSX是ES的语法糖，ES语句的灵活性使其很难进行静态分析。

> 拓展 那么Template语法是如何从中受益的呢？

> 1. **解析**：将模板字符串解析成抽象语法树（AST）。AST是一种树形结构，用于表示模板中的元素、属性、文本节点等。
> 2. **优化**：遍历AST，对其中的静态内容（如纯文本节点、静态属性等）进行标记。这些标记在后续的渲染过程中有助于避免不必要的计算和更新，从而提高性能。
> 3. **代码生成**：将优化后的AST转换成可执行的JavaScript代码。这通常包括生成渲染函数（render function）和虚拟DOM节点。渲染函数用于创建和更新实际的DOM结构。

模板语法由于在构建时已经被编译成可执行的JavaScript代码，运行时无需再进行**解析和编译，从而减少了性能开销**。


